machine:
  node:
    version: 6.10.2

dependencies:
  pre:
    - curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo dpkg -i google-chrome.deb
    - sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
    - rm google-chrome.deb

  cache_directories:
      - "node_modules"
      - "~/.npm"
      - "~/.meteor"
      #- "~/.ultrawide_data"

  override:

    # Create Ultrawide working dir
    #- sh /home/ubuntu/ultrawide/scripts/setup-dirs.sh

    # Install & cache Meteor
    - sh /home/ubuntu/ultrawide/scripts/install-meteor.sh

    #- curl https://install.meteor.com | /bin/sh

    # Install and cache NPM dependencies
    - npm install

    # Install chimp
    - npm install -g chimp

    # Download & cache Chimp's dependencies
    - sh /home/ubuntu/ultrawide/scripts/download-chimp-dependencies.sh

checkout:
  post:
    - git submodule update --init

test:
  override:
    # Run Meteor unit tests
    #- npm run test:unit

    # Run integration tests.  Will need a data location and the app running in background
    - npm run start-ci:
        background: true
    # Seems to take 3 mins to start app... :(
    - sleep 180
    - npm run chimp:int_server_des

  post:
    - npm run upload-unit-results

    - pkill -SIGQUIT meteor

